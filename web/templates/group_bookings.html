{% extends "base.html" %} {% block title %}Group Bookings{% endblock %} {% block page_title %}Group Bookings{% endblock
%} {% block content %}
<!-- Add New Group Form - Always Visible -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-plus"></i>
          <span id="formTitle">Add New Group Booking</span>
        </h3>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('groups.manage_bookings') }}" id="groupForm">
          <input type="hidden" id="booking_id" name="booking_id" value="" />
          <input type="hidden" id="form_action" name="form_action" value="create" />

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="group_name">
                  Group Name
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="group_name"
                  name="group_name"
                  placeholder="Enter group name"
                  required
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="visit_date">
                  Visit Date
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="visit_date"
                    name="visit_date"
                    placeholder="Select visit date"
                    required
                    readonly="readonly"
                  />
                  <div class="input-group-append">
                    <span class="input-group-text" style="cursor: pointer" id="calendar-icon">
                      <i class="fas fa-calendar"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="contact_person">
                  Contact Person
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="contact_person"
                  name="contact_person"
                  placeholder="Enter contact person name"
                  required
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="mobile_number">
                  Mobile Number
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="tel"
                  class="form-control"
                  id="mobile_number"
                  name="mobile_number"
                  placeholder="e.g., +27 82 123 4567"
                  required
                />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save"></i>
                <span id="submitBtnText">Create Booking</span>
              </button>
              <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none">
                <i class="fas fa-times"></i>
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bookings Table -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-list"></i>
          All Group Bookings
        </h3>
      </div>
      <div class="card-body">
        <table id="bookingsTable" class="table table-bordered table-striped table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Group Name</th>
              <th>Contact Person</th>
              <th>Mobile Number</th>
              <th>Visit Date</th>
              <th>Barcode</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if bookings %} {% for booking in bookings %}
            <tr>
              <td data-label="ID">{{ booking.id }}</td>
              <td data-label="Group Name"><strong>{{ booking.group_name }}</strong></td>
              <td data-label="Contact Person">{{ booking.contact_person }}</td>
              <td data-label="Mobile Number" class="text-nowrap">{{ booking.mobile_number }}</td>
              <td data-label="Visit Date" class="text-nowrap">{{ booking.visit_date }}</td>
              <td data-label="Barcode"><code>{{ booking.barcode }}</code></td>
              <td data-label="Actions" class="text-center text-nowrap">
                <div class="btn-group-actions">
                  <a
                    href="{{ url_for('groups.view_ticket', barcode=booking.barcode) }}"
                    class="btn btn-info btn-sm"
                    target="_blank"
                    data-toggle="tooltip"
                    title="View Ticket"
                  >
                    <i class="fas fa-eye"></i>
                  </a>
                  <button
                    type="button"
                    class="btn btn-warning btn-sm edit-booking"
                    data-id="{{ booking.id }}"
                    data-group-name="{{ booking.group_name }}"
                    data-contact-person="{{ booking.contact_person }}"
                    data-mobile-number="{{ booking.mobile_number }}"
                    data-visit-date="{{ booking.visit_date }}"
                    data-toggle="tooltip"
                    title="Edit Booking"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-danger btn-sm delete-booking"
                    data-id="{{ booking.id }}"
                    data-group-name="{{ booking.group_name }}"
                    data-toggle="tooltip"
                    title="Delete Booking"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                  <a
                    href="{{ url_for('groups.download_ticket', barcode=booking.barcode) }}"
                    class="btn btn-success btn-sm"
                    data-toggle="tooltip"
                    title="Download Ticket"
                  >
                    <i class="fas fa-download"></i>
                  </a>
                  <button
                    type="button"
                    class="btn btn-primary btn-sm send-whatsapp"
                    data-barcode="{{ booking.barcode }}"
                    data-mobile="{{ booking.mobile_number }}"
                    data-group-name="{{ booking.group_name }}"
                    data-toggle="tooltip"
                    title="Send via WhatsApp"
                  >
                    <i class="fab fa-whatsapp"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %} {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted">
                <i class="fas fa-inbox"></i>
                No bookings yet. Create your first one above!
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  class="modal fade"
  id="deleteModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="deleteModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="fas fa-exclamation-triangle"></i>
          Confirm Delete
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this booking?</p>
        <p>
          <strong>Group Name:</strong>
          <span id="deleteGroupName"></span>
        </p>
        <p class="text-warning">
          <i class="fas fa-exclamation-circle"></i>
          This action cannot be undone!
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <form method="POST" action="{{ url_for('groups.delete_booking') }}" id="deleteForm">
          <input type="hidden" name="booking_id" id="deleteBookingId" />
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash"></i>
            Delete Booking
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // Initialize DataTable
  $(document).ready(function() {
      var table = $('#bookingsTable').DataTable({
          "responsive": true,
          "lengthChange": false,
          "autoWidth": false,
          "pageLength": 10,
          "order": [[0, "desc"]], // Sort by ID descending (newest first)
          "language": {
              "search": "Search bookings:",
              "lengthMenu": "Show _MENU_ bookings per page",
              "info": "Showing _START_ to _END_ of _TOTAL_ bookings",
              "infoEmpty": "No bookings available",
              "infoFiltered": "(filtered from _MAX_ total bookings)",
              "zeroRecords": "No matching bookings found"
          },
          "drawCallback": function() {
              // Reinitialize tooltips after table redraw
              $('[data-toggle="tooltip"]').tooltip();
          }
      });

      // Initialize tooltips
      $('[data-toggle="tooltip"]').tooltip();
  });

  // Initialize Flatpickr date picker
  const datePicker = flatpickr("#visit_date", {
      dateFormat: "Y-m-d",
      minDate: "today",
      altInput: true,
      altFormat: "F j, Y",
      allowInput: false  // Prevent manual typing
  });

  // Make calendar icon clickable
  document.getElementById('calendar-icon').addEventListener('click', function() {
      datePicker.open();
  });

  // Edit booking functionality
  $(document).on('click', '.edit-booking', function() {
      var id = $(this).data('id');
      var groupName = $(this).data('group-name');
      var contactPerson = $(this).data('contact-person');
      var mobileNumber = $(this).data('mobile-number');
      var visitDate = $(this).data('visit-date');

      // Populate form
      $('#booking_id').val(id);
      $('#form_action').val('update');
      $('#group_name').val(groupName);
      $('#contact_person').val(contactPerson);
      $('#mobile_number').val(mobileNumber);
      datePicker.setDate(visitDate);

      // Update form UI
      $('#formTitle').text('Edit Group Booking');
      $('#submitBtnText').text('Update Booking');
      $('#submitBtn').removeClass('btn-primary').addClass('btn-warning');
      $('#submitBtn i').removeClass('fa-save').addClass('fa-edit');
      $('#cancelBtn').show();

      // Scroll to form
      $('html, body').animate({
          scrollTop: $('#groupForm').offset().top - 100
      }, 500);
  });

  // Cancel edit functionality
  $('#cancelBtn').click(function() {
      resetForm();
  });

  // Reset form function
  function resetForm() {
      $('#groupForm')[0].reset();
      $('#booking_id').val('');
      $('#form_action').val('create');
      $('#formTitle').text('Add New Group Booking');
      $('#submitBtnText').text('Create Booking');
      $('#submitBtn').removeClass('btn-warning').addClass('btn-primary');
      $('#submitBtn i').removeClass('fa-edit').addClass('fa-save');
      $('#cancelBtn').hide();
      datePicker.clear();
  }

  // Delete booking functionality
  $(document).on('click', '.delete-booking', function() {
      var id = $(this).data('id');
      var groupName = $(this).data('group-name');

      $('#deleteBookingId').val(id);
      $('#deleteGroupName').text(groupName);
      $('#deleteModal').modal('show');
  });

  // Send via WhatsApp functionality
  $(document).on('click', '.send-whatsapp', function() {
      var button = $(this);
      var barcode = button.data('barcode');
      var mobile = button.data('mobile');
      var groupName = button.data('group-name');

      // Disable button and show loading state
      button.prop('disabled', true);
      var originalHtml = button.html();
      button.html('<i class="fas fa-spinner fa-spin"></i>');

      // Send AJAX request
      $.ajax({
          url: '{{ url_for("groups.send_whatsapp_ticket") }}',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
              barcode: barcode
          }),
          success: function(response) {
              button.prop('disabled', false);
              button.html(originalHtml);

              if (response.success) {
                  toastr.success('Ticket sent successfully via WhatsApp to ' + mobile + '!');
              } else {
                  toastr.error('Failed to send ticket: ' + (response.error || 'Unknown error'));
              }
          },
          error: function(xhr, status, error) {
              button.prop('disabled', false);
              button.html(originalHtml);

              var errorMsg = 'Error sending ticket via WhatsApp';
              try {
                  var response = JSON.parse(xhr.responseText);
                  errorMsg = response.error || errorMsg;
              } catch(e) {
                  errorMsg = error || errorMsg;
              }

              toastr.error(errorMsg);
          }
      });
  });

  // Show toast notifications for flash messages
  {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
          {% for category, message in messages %}
              toastr.{{ category }}('{{ message }}');
          {% endfor %}
      {% endif %}
  {% endwith %}

  // Configure toastr options
  toastr.options = {
      "closeButton": true,
      "progressBar": true,
      "positionClass": "toast-top-right",
      "timeOut": "5000",
      "extendedTimeOut": "1000"
  };
</script>
{% endblock %}
