{% extends "base.html" %} {% block title %}Group Bookings{% endblock %} {% block page_title %}Group Bookings{% endblock
%} {% block content %} {% set current_action = request.form.get('form_action', 'create') %} {% set is_edit =
(current_action == 'update') %}

<!-- Add New Group Form - Always Visible -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-plus"></i>
          <span id="formTitle">{% if is_edit %}Edit Group Booking{% else %}Add New Group Booking{% endif %}</span>
        </h3>
      </div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('groups.manage_bookings') }}" id="groupForm">
          <input type="hidden" id="booking_id" name="booking_id" value="{{ request.form.get('booking_id', '') }}" />
          <input type="hidden" id="form_action" name="form_action" value="{{ current_action }}" />

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="group_name">
                  Group Name
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="group_name"
                  name="group_name"
                  placeholder="Enter group name"
                  required
                  value="{{ request.form.get('group_name', '') }}"
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="visit_date">
                  Visit Date
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    id="visit_date"
                    name="visit_date"
                    placeholder="Select visit date"
                    required
                    readonly="readonly"
                    value="{{ request.form.get('visit_date', '') }}"
                  />
                  <div class="input-group-append">
                    <span class="input-group-text" style="cursor: pointer" id="calendar-icon">
                      <i class="fas fa-calendar"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="contact_person">
                  Contact Person
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  class="form-control"
                  id="contact_person"
                  name="contact_person"
                  placeholder="Enter contact person name"
                  required
                  value="{{ request.form.get('contact_person', '') }}"
                />
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="mobile_number">
                  Mobile Number
                  <span class="text-danger">*</span>
                </label>
                <input
                  type="tel"
                  class="form-control"
                  id="mobile_number"
                  name="mobile_number"
                  placeholder="e.g., +27 82 123 4567"
                  required
                  value="{{ request.form.get('mobile_number', '') }}"
                />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <button
                type="submit"
                class="btn {% if is_edit %}btn-warning{% else %}btn-primary{% endif %}"
                id="submitBtn"
              >
                <i class="fas {% if is_edit %}fa-edit{% else %}fa-save{% endif %}"></i>
                <span id="submitBtnText">{% if is_edit %}Update Booking{% else %}Create Booking{% endif %}</span>
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                id="cancelBtn"
                style="{% if is_edit %}display: inline-block{% else %}display: none{% endif %}"
              >
                <i class="fas fa-times"></i>
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bookings Table -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-list"></i>
          All Group Bookings
        </h3>
        <div class="card-tools">
          <div class="btn-group btn-group-sm date-filter-buttons" role="group">
            <button type="button" class="btn btn-outline-primary active" data-filter="all">
              <i class="fas fa-list"></i>
              All
            </button>
            <button type="button" class="btn btn-outline-primary" data-filter="today">
              <i class="fas fa-calendar-day"></i>
              Today
            </button>
            <button type="button" class="btn btn-outline-primary" data-filter="week">
              <i class="fas fa-calendar-week"></i>
              Next 7 Days
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <table id="bookingsTable" class="table table-bordered table-striped table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Group Name</th>
              <th>Contact Person</th>
              <th>Mobile Number</th>
              <th>Visit Date</th>
              <th>Barcode</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if bookings %} {% for booking in bookings %}
            <tr>
              <td data-label="ID">{{ booking.id }}</td>
              <td data-label="Group Name"><strong>{{ booking.group_name }}</strong></td>
              <td data-label="Contact Person">{{ booking.contact_person }}</td>
              <td data-label="Mobile Number" class="text-nowrap">{{ booking.mobile_number_display }}</td>
              <td data-label="Visit Date" class="text-nowrap">{{ booking.visit_date }}</td>
              <td data-label="Barcode"><code>{{ booking.barcode }}</code></td>
              <td data-label="Actions" class="text-center text-nowrap">
                <div class="btn-group-actions">
                  <a
                    href="{{ url_for('groups.view_ticket', barcode=booking.barcode) }}"
                    class="btn btn-info btn-sm"
                    target="_blank"
                    data-toggle="tooltip"
                    title="View Ticket"
                  >
                    <i class="fas fa-eye"></i>
                  </a>
                  <button
                    type="button"
                    class="btn btn-warning btn-sm edit-booking"
                    data-id="{{ booking.id }}"
                    data-group-name="{{ booking.group_name }}"
                    data-contact-person="{{ booking.contact_person }}"
                    data-mobile-number="{{ booking.mobile_number }}"
                    data-visit-date="{{ booking.visit_date }}"
                    data-toggle="tooltip"
                    title="Edit Booking"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-danger btn-sm delete-booking"
                    data-id="{{ booking.id }}"
                    data-group-name="{{ booking.group_name }}"
                    data-toggle="tooltip"
                    title="Delete Booking"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                  <a
                    href="{{ url_for('groups.download_ticket', barcode=booking.barcode) }}"
                    class="btn btn-success btn-sm"
                    data-toggle="tooltip"
                    title="Download Ticket"
                  >
                    <i class="fas fa-download"></i>
                  </a>
                  <button
                    type="button"
                    class="btn btn-primary btn-sm send-whatsapp"
                    data-barcode="{{ booking.barcode }}"
                    data-mobile="{{ booking.mobile_number }}"
                    data-group-name="{{ booking.group_name }}"
                    data-contact-person="{{ booking.contact_person }}"
                    data-visit-date="{{ booking.visit_date }}"
                    data-toggle="tooltip"
                    title="Send via WhatsApp"
                  >
                    <i class="fab fa-whatsapp"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %} {% else %}
            <tfoot>
              <tr>
                <td colspan="7" class="text-center text-muted">
                  <i class="fas fa-inbox"></i>
                  No bookings yet. Create your first one above!
                </td>
              </tr>
            </tfoot>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  class="modal fade"
  id="deleteModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="deleteModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="fas fa-exclamation-triangle"></i>
          Confirm Delete
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this booking?</p>
        <p>
          <strong>Group Name:</strong>
          <span id="deleteGroupName"></span>
        </p>
        <p class="text-warning">
          <i class="fas fa-exclamation-circle"></i>
          This action cannot be undone!
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <form method="POST" action="{{ url_for('groups.delete_booking') }}" id="deleteForm">
          <input type="hidden" name="booking_id" id="deleteBookingId" />
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash"></i>
            Delete Booking
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // Initialize DataTable
  $(document).ready(function() {
      var table = $('#bookingsTable').DataTable({
          "responsive": true,
          "lengthChange": false,
          "autoWidth": false,
          "pageLength": 10,
          "order": [[0, "desc"]], // Sort by ID descending (newest first)
          "language": {
              "search": "Search bookings:",
              "lengthMenu": "Show _MENU_ bookings per page",
              "info": "Showing _START_ to _END_ of _TOTAL_ bookings",
              "infoEmpty": "No bookings available",
              "infoFiltered": "(filtered from _MAX_ total bookings)",
              "zeroRecords": "No matching bookings found"
          },
          "drawCallback": function() {
              // Reinitialize tooltips after table redraw
              $('[data-toggle="tooltip"]').tooltip();
          }
      });

      // Initialize tooltips
      $('[data-toggle="tooltip"]').tooltip();

      // Date filter buttons
      $('.date-filter-buttons button').on('click', function() {
          var filter = $(this).data('filter');

          // Update active button state
          $('.date-filter-buttons button').removeClass('active');
          $(this).addClass('active');

          // Apply filter
          applyDateFilter(table, filter);
      });

      // Loading state on form submit (create / update booking)
      $('#groupForm').on('submit', function(e) {
          var btn = $('#submitBtn');

          // Prevent double submission
          if (btn.prop('disabled')) {
              e.preventDefault();
              return;
          }

          var action = $('#form_action').val();
          var loadingText = (action === 'update') ? 'Updating...' : 'Creating...';

          btn.prop('disabled', true);
          $('#cancelBtn').prop('disabled', true);

          // Swap icon to spinner and update text
          btn.find('i')
              .removeClass('fa-save fa-edit')
              .addClass('fa-spinner fa-spin');
          $('#submitBtnText').text(loadingText);
      });
  });

  // Apply date filter to DataTable
  function applyDateFilter(table, filter) {
      var today = new Date();
      today.setHours(0, 0, 0, 0);

      // Clear previous custom filters
      $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(function(fn) {
          return false;
      });

      if (filter === 'today') {
          $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
              var raw = data[4]; // Column index 4 is visit_date
              if (!raw) return false;
              var visitDate = new Date(raw);
              visitDate.setHours(0, 0, 0, 0);
              return visitDate.getTime() === today.getTime();
          });
      } else if (filter === 'week') {
          var weekFromNow = new Date();
          weekFromNow.setDate(today.getDate() + 7);
          weekFromNow.setHours(23, 59, 59, 999);

          $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
              var raw = data[4];
              if (!raw) return false;
              var visitDate = new Date(raw);
              visitDate.setHours(0, 0, 0, 0);
              return visitDate.getTime() >= today.getTime() && visitDate.getTime() <= weekFromNow.getTime();
          });
      }

      table.draw();
  }

  // Initialize Flatpickr date picker
  const datePicker = flatpickr("#visit_date", {
      dateFormat: "Y-m-d",
      minDate: "today",
      altInput: true,
      altFormat: "F j, Y",
      allowInput: false  // Prevent manual typing
  });

  // Restore date after validation error if value exists
  const existingDate = document.getElementById('visit_date').value;
  if (existingDate) {
      datePicker.setDate(existingDate, true);
  }

  // Make calendar icon clickable
  document.getElementById('calendar-icon').addEventListener('click', function() {
      datePicker.open();
  });

  // Edit booking functionality
  $(document).on('click', '.edit-booking', function() {
      var id = $(this).data('id');
      var groupName = $(this).data('group-name');
      var contactPerson = $(this).data('contact-person');
      var mobileNumber = $(this).data('mobile-number');
      var visitDate = $(this).data('visit-date');

      // Populate form
      $('#booking_id').val(id);
      $('#form_action').val('update');
      $('#group_name').val(groupName);
      $('#contact_person').val(contactPerson);
      $('#mobile_number').val(mobileNumber);
      datePicker.setDate(visitDate, true);

      // Update form UI
      $('#formTitle').text('Edit Group Booking');
      $('#submitBtnText').text('Update Booking');
      $('#submitBtn').removeClass('btn-primary').addClass('btn-warning');
      $('#submitBtn i').removeClass('fa-save').addClass('fa-edit');
      $('#cancelBtn').show();

      // Scroll to form
      $('html, body').animate({
          scrollTop: $('#groupForm').offset().top - 100
      }, 500);
  });

  // Cancel edit functionality
  $('#cancelBtn').click(function() {
      resetForm();
  });

  // Reset form function
  function resetForm() {
      $('#groupForm')[0].reset();
      $('#booking_id').val('');
      $('#form_action').val('create');
      $('#formTitle').text('Add New Group Booking');
      $('#submitBtnText').text('Create Booking');
      $('#submitBtn').removeClass('btn-warning').addClass('btn-primary');
      $('#submitBtn i').removeClass('fa-edit').addClass('fa-save');
      $('#cancelBtn').hide();
      $('#cancelBtn').prop('disabled', false);
      datePicker.clear();
  }

  // Delete booking functionality
  $(document).on('click', '.delete-booking', function() {
      var id = $(this).data('id');
      var groupName = $(this).data('group-name');

      $('#deleteBookingId').val(id);
      $('#deleteGroupName').text(groupName);
      $('#deleteModal').modal('show');
  });

  // Send via WhatsApp functionality
  $(document).on('click', '.send-whatsapp', function() {
      var button = $(this);
      var barcode = button.data('barcode');
      var mobile = button.data('mobile');
      var groupName = button.data('group-name');
      var contactPerson = button.data('contact-person');
      var visitDate = button.data('visit-date');

      // Disable button and show loading state
      button.prop('disabled', true);
      var originalHtml = button.html();
      button.html('<i class="fas fa-spinner fa-spin"></i>');

      // Send AJAX request to server endpoint that handles the template send
      $.ajax({
          url: '{{ url_for("groups.send_whatsapp_ticket") }}',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
              barcode: barcode,
              mobile: mobile,
              group_name: groupName,
              contact_person: contactPerson,
              visit_date: visitDate
          }),
          success: function(response) {
              button.prop('disabled', false);
              button.html(originalHtml);

              if (response.success) {
                  toastr.success('Ticket sent successfully via WhatsApp to ' + mobile + '!');
              } else {
                  toastr.error('Failed to send ticket: ' + (response.error || 'Unknown error'));
              }
          },
          error: function(xhr, status, error) {
              button.prop('disabled', false);
              button.html(originalHtml);

              var errorMsg = 'Error sending ticket via WhatsApp';
              try {
                  var response = JSON.parse(xhr.responseText);
                  errorMsg = response.error || errorMsg;
              } catch(e) {
                  errorMsg = error || errorMsg;
              }

              toastr.error(errorMsg);
          }
      });
  });

  // Show toast notifications for flash messages
  {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
          {% for category, message in messages %}
              toastr.{{ category }}('{{ message }}');
          {% endfor %}
      {% endif %}
  {% endwith %}

  // Configure toastr options
  toastr.options = {
      "closeButton": true,
      "progressBar": true,
      "positionClass": "toast-top-right",
      "timeOut": "5000",
      "extendedTimeOut": "1000"
  };
</script>
{% endblock %}
