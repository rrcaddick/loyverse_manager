{% extends "base.html" %} {% block title %}Scripts{% endblock %} {% block page_title %}Scripts{% endblock %} {% block
content %}
<div class="row">
  <div class="col-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-terminal"></i>
          Run Maintenance Scripts
        </h3>
      </div>
      <div class="card-body">
        <p class="text-muted">Click a button to run a script. You’ll get live feedback below.</p>

        <div class="btn-group flex-wrap" role="group" aria-label="Scripts">
          <button type="button" class="btn btn-primary m-1 script-btn" data-script="add_inventory">
            <i class="fas fa-boxes"></i>
            Run Add Inventory
          </button>

          <button type="button" class="btn btn-warning m-1 script-btn" data-script="clear_inventory">
            <i class="fas fa-trash-alt"></i>
            Run Clear Inventory
          </button>

          <button type="button" class="btn btn-info m-1 script-btn" data-script="hide_quicket_event">
            <i class="fas fa-eye-slash"></i>
            Hide Quicket Event
          </button>
        </div>

        <hr />

        <div id="scriptResult" class="mt-3 small text-muted">No scripts run yet.</div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Add Inventory Modal -->
<div
  class="modal fade"
  id="confirmAddModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="confirmAddModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="confirmAddModalLabel">Confirm Add Inventory</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
          Running
          <strong>Add Inventory</strong>
          will:
        </p>
        <ul>
          <li>
            <strong>Clear Inventory</strong>
            for today.
          </li>
          <li>Then rebuild today's inventory in Loyverse from Quicket tickets and group bookings.</li>
        </ul>
        <p class="mb-0 text-danger">
          This will effectively
          <strong>reset today's inventory levels</strong>
          in Loyverse.
        </p>
        <p class="mb-0 text-danger">
          This should only be done if you have
          <strong>not yet been begun processing today's items in Loyverse</strong>
          .
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmAddBtn">Yes, run Clear then Add Inventory</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Clear Inventory Modal -->
<div
  class="modal fade"
  id="confirmClearModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="confirmClearModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="confirmClearModalLabel">Confirm Clear Inventory</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
          Running
          <strong>Clear Inventory</strong>
          will:
        </p>
        <ul>
          <li>Clear all online tickets and group items.</li>
          <li>Reset today's Gazebo inventory levels.</li>
        </ul>
        <p class="mb-0 text-danger">
          This should only be done if you have
          <strong>not yet been begun processing today's items in Loyverse</strong>
          .
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmClearBtn">Yes, clear today's inventory</button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  $(function () {
    var lastClickedButton = null;

    function runScriptAjax(scriptName) {
      var labelName = scriptName;
      $("#scriptResult").text("Running '" + labelName + "' ...");

      return $.ajax({
        url: "{{ url_for('scripts.run_script') }}",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({ name: scriptName }),
      });
    }

    function runSingleScript($btn, scriptName) {
      var originalHtml = $btn.html();
      $btn.prop("disabled", true);
      $btn.html('<i class="fas fa-spinner fa-spin"></i> Running...');

      runScriptAjax(scriptName)
        .done(function (response) {
          if (response && response.success) {
            toastr.success("Script ran successfully: " + scriptName);
            $("#scriptResult").text("Last run: " + scriptName + " — SUCCESS at " + new Date().toLocaleString());
          } else {
            var err = (response && response.error) || "Unknown error (script failed)";
            toastr.error("Script failed: " + err);
            $("#scriptResult").text(
              "Last run: " + scriptName + " — FAILED: " + err + " (" + new Date().toLocaleString() + ")"
            );
          }
        })
        .fail(function (xhr) {
          var msg = "Error running script";
          try {
            var data = JSON.parse(xhr.responseText);
            if (data.error) {
              msg = data.error;
            }
          } catch (e) {}
          toastr.error(msg);
          $("#scriptResult").text(
            "Last run: " + scriptName + " — ERROR: " + msg + " (" + new Date().toLocaleString() + ")"
          );
        })
        .always(function () {
          $btn.prop("disabled", false);
          $btn.html(originalHtml);
        });
    }

    $(".script-btn").on("click", function () {
      var $btn = $(this);
      var scriptName = $btn.data("script");
      lastClickedButton = $btn;

      if (scriptName === "add_inventory") {
        $("#confirmAddModal").modal("show");
      } else if (scriptName === "clear_inventory") {
        $("#confirmClearModal").modal("show");
      } else {
        // hide_quicket_event and any others run immediately
        runSingleScript($btn, scriptName);
      }
    });

    $("#confirmAddBtn").on("click", function () {
      $("#confirmAddModal").modal("hide");

      var $btn = lastClickedButton;
      if (!$btn || !$btn.length) {
        return;
      }

      var originalHtml = $btn.html();
      $btn.prop("disabled", true);
      $btn.html('<i class="fas fa-spinner fa-spin"></i> Running...');
      $("#scriptResult").text("Running Clear Inventory, then Add Inventory...");

      // 1) CLEAR
      runScriptAjax("clear_inventory")
        .done(function (response) {
          if (!response || !response.success) {
            var err = (response && response.error) || "Unknown error (clear_inventory failed)";
            toastr.error("Clear Inventory failed: " + err);
            $("#scriptResult").text("Clear Inventory — FAILED: " + err + " (" + new Date().toLocaleString() + ")");
            // stop here, don't run add
            $btn.prop("disabled", false);
            $btn.html(originalHtml);
            return;
          }

          // Clear succeeded, now run Add
          $("#scriptResult").text("Clear Inventory — SUCCESS. Now running Add Inventory...");
          ``;

          // 2) ADD
          runScriptAjax("add_inventory")
            .done(function (addResponse) {
              if (addResponse && addResponse.success) {
                toastr.success("Add Inventory completed successfully.");
                $("#scriptResult").text("Add Inventory — SUCCESS at " + new Date().toLocaleString());
              } else {
                var addErr = (addResponse && addResponse.error) || "Unknown error (add_inventory failed)";
                toastr.error("Add Inventory failed: " + addErr);
                $("#scriptResult").text("Add Inventory — FAILED: " + addErr + " (" + new Date().toLocaleString() + ")");
              }
            })
            .fail(function (xhr) {
              var msg = "Error running Add Inventory";
              try {
                var data = JSON.parse(xhr.responseText);
                if (data.error) {
                  msg = data.error;
                }
              } catch (e) {}
              toastr.error(msg);
              $("#scriptResult").text("Add Inventory — ERROR: " + msg + " (" + new Date().toLocaleString() + ")");
            })
            .always(function () {
              // only re-enable once BOTH have finished
              $btn.prop("disabled", false);
              $btn.html(originalHtml);
            });
        })
        .fail(function (xhr) {
          var msg = "Error running Clear Inventory";
          try {
            var data = JSON.parse(xhr.responseText);
            if (data.error) {
              msg = data.error;
            }
          } catch (e) {}
          toastr.error(msg);
          $("#scriptResult").text("Clear Inventory — ERROR: " + msg + " (" + new Date().toLocaleString() + ")");
          $btn.prop("disabled", false);
          $btn.html(originalHtml);
        });
    });

    $("#confirmClearBtn").on("click", function () {
      $("#confirmClearModal").modal("hide");
      var $btn = lastClickedButton;
      if (!$btn || !$btn.length) {
        return;
      }
      runSingleScript($btn, "clear_inventory");
    });
  });
</script>
{% endblock %}
